name: E2E tests

on:
  push:
    branches: main
  pull_request:
  workflow_dispatch:

jobs:
  cypress-run:
    runs-on: self-hosted
    # runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: actions/setup-node@v3
        with:
          node-version: "20.x"
          registry-url: "https://registry.npmjs.org"
          cache: "npm"

      # https://docs.cypress.io/guides/continuous-integration/introduction#Dependencies
      - name: Install dependencies
        run: sudo pacman -Sy libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libnss3 libxss1 libasound2 libxtst6 xauth xvfb

      - name: Cypress run
        uses: cypress-io/github-action@v6
        with:
          build: npm run build
          start: npm run start
        env:
          NEXT_PUBLIC_MOCK_CONNECTOR: true
          NEXT_PUBLIC_E2E_WALLET_MNEMONIC: ${{ secrets.NEXT_PUBLIC_E2E_WALLET_MNEMONIC }}
          CYPRESS_DC_BOT_TOKEN: ${{ secrets.CYPRESS_DC_BOT_TOKEN }}
          KV_URL: ${{ secrets.KV_URL }}
          KV_REST_API_URL: ${{ secrets.KV_REST_API_URL }}
          KV_REST_API_TOKEN: ${{ secrets.KV_REST_API_TOKEN }}

      - name: Upload artifacts
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: screenshots-videos
          path: |
            cypress/screenshots
            cypress/videos

      - name: Send Discord notification
        if: ${{ failure() && github.ref == 'refs/heads/main' }}
        shell: bash
        run: curl -X POST -H 'Content-Type:application/json' -d '{"embeds":[{"title":"Failing test","fields":[{"name":"Trigger","value":"${{github.event_name}}"},{"name":"Action","value":"https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}"}],"color":15548997}]}' ${{ secrets.FAILING_E2E_TEST_DC_WEBHOOK }}
